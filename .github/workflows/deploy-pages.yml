name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'wiki-default/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    # Only deploy main branch to GitHub Pages
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate navigation links
        run: |
          echo "Checking for external links in navigation sidebar..."
          
          # Check if sidebar.md exists
          if [ ! -f "wiki-default/sidebar.md" ]; then
            echo "Error: sidebar.md not found"
            exit 1
          fi
          
          # Extract all markdown links from sidebar.md and check for external URLs
          # Allowlist specific external links (project GitHub)
          ALLOWLIST=("https://github.com/simoninns/decode-orc")
          
          # Find external links and extract just the URL (remove ]( prefix and ) suffix)
          EXTERNAL_LINKS=$(grep -oE '\]\(https?://[^)]+\)' wiki-default/sidebar.md | cut -c3- | sed 's/)$//' || true)
          
          # Filter out allowlisted URLs
          FILTERED_LINKS=""
          while IFS= read -r url; do
            [[ -z "$url" ]] && continue
            skip=false
            for allowed in "${ALLOWLIST[@]}"; do
              if [[ "$url" == "$allowed" ]]; then
                skip=true
                break
              fi
            done
            if [[ "$skip" == false ]]; then
              FILTERED_LINKS+="$url"$'\n'
            fi
          done < <(echo "$EXTERNAL_LINKS")
          
          if [[ -n "$FILTERED_LINKS" ]]; then
            echo "❌ ERROR: External links found in navigation sidebar!"
            echo ""
            echo "The following external links were detected (excluding allowlist):"
            echo "$FILTERED_LINKS"
            echo ""
            echo "External links in the navigation are not allowed - Deployment failed"
            echo "Please create local placeholder pages and link to those instead."
            exit 1
          fi
          
          echo "✓ Navigation validation passed - no disallowed external links found"
      
      - name: Check internal markdown links
        run: |
          chmod +x check-internal-linkage.sh
          ./check-internal-linkage.sh
      
      - name: Check for orphaned pages
        run: |
          chmod +x check-orphans.sh
          ./check-orphans.sh
      
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Build site with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./wiki-default
          destination: ./_site
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
